<!DOCTYPE html>
<html>
<head>
  <title>Jagannath Wellness Order Placing Platform</title>
</head>
<body>
  <h1>Place an Order</h1>

  <label>Product Name:
    <input type="text" id="productName">
  </label>
  <button onclick="fetchProduct()">Get Product Details</button>

  <div id="productInfo" style="display:none;">
    <p>MRP: <span id="mrp"></span></p>
    <p>Price: <span id="price"></span></p>
    <p>SP: <span id="sp"></span></p>

    <label>Quantity:
      <input type="number" id="quantity" value="1" min="1">
    </label>
  </div>

  <h3>Customer Details</h3>
  <label>Name: <input type="text" id="customerName"></label><br>
  <label>Phone: <input type="text" id="customerPhone"></label><br><br>

  <button onclick="placeOrder()">Place Order</button>

  <p id="orderResult"></p>

  <script>
    let fetchedProduct = null;

    /**
     * Fetches a product based on the name entered by the user.
     *
     * @return {Promise} resolves if the product is found.
     */
    async function fetchProduct() {
      const name = document.getElementById('productName').value;

      if (!name) {
        alert("Please enter a product name");
        return;
      }

      try {
        // Fetch the product from the server.
        const response = await fetch('https://delicate-meadow-ca6a.akashparida-official.workers.dev/get-product?name=' + encodeURIComponent(name));
        const data = await response.json();

        if (data.length === 0) {
          // If the product is not found, show an error message.
          alert("Product not found.");
          return;
        }

        // Extract the first product from the response.
        const product = data[0];

        // Update the product details in the UI.
        document.getElementById('mrp').textContent = product.MRP;
        document.getElementById('price').textContent = product.price;
        document.getElementById('sp').textContent = product.SP;
        document.getElementById('productInfo').style.display = 'block';
        fetchedProduct = product;
      } catch (error) {
        // Handle any errors that occur during the fetch.
        console.error("Error fetching product:", error.message);
        alert("Failed to fetch product details: " + error.message);
      }
    }

    /**
     * Place an order for a product.
     *
     * @return {Promise} resolves if the order is placed successfully.
     */
    async function placeOrder() {
      if (!fetchedProduct) {
        alert("Please fetch a product first.");
        return;
      }

      const quantity = parseInt(document.getElementById('quantity').value);
      const totalValue = quantity * fetchedProduct.price;
      const totalSP = quantity * fetchedProduct.SP;

      // Create an order with a single item.
      // The order should contain the customer's name, phone number, and
      // the product details.
      const order = {
        customer_name: document.getElementById('customerName').value,
        customer_phone: document.getElementById('customerPhone').value,
        items: JSON.stringify([{
          name: fetchedProduct.name,
          uid: fetchedProduct.uid,
          price: fetchedProduct.price,
          quantity: quantity
        }]),
        total_value: totalValue,
        total_sp: totalSP
      };

      try {
        // Make a POST request to the server with the order details.
        const response = await fetch('https://delicate-meadow-ca6a.akashparida-official.workers.dev/place-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(order)
        });

        // Check if the order was placed successfully.
        if (response.ok) {
          document.getElementById('orderResult').textContent = 'Order placed successfully!';
        } else {
          document.getElementById('orderResult').textContent = 'Failed to place order.';
          throw new Error(`Failed to place order. Status: ${response.status}`);
        }
      } catch (error) {
        console.error("Error placing order:", error);
        document.getElementById('orderResult').textContent = 'Failed to place order.';
      }
    }
  </script>
</body>
</html>
